# P0.3-A — Chart "Flux d'entrées" : Toggle + Normalisation + Tooltips

## 1. Ticket title
**Toggle Barres/Cumul/Combiné + Normalisation axes + Tooltips sur chart "Flux d'entrées"**

## 2. Goal (1–2 lines)
Rendre le chart "Flux d'entrées" lisible à 3 mètres en ajoutant :
1. Un toggle pour basculer entre vue Barres, Cumul, ou Combiné
2. Une normalisation stricte des axes Y (pas de démarre sous 0, domaines stables)
3. Des tooltips au tap affichant valeur + date + delta vs période précédente

## 3. Scope (bullets)
- ✅ Ajouter un **ChartDisplayMode** enum (`bars`, `cumulative`, `combined`) dans DashboardViewModel
- ✅ Ajouter un **Picker/SegmentedControl** au-dessus du chart pour sélectionner le mode
- ✅ Refactoriser `combinedChart` pour afficher conditionellement selon le mode sélectionné
- ✅ **Normaliser axes Y** :
  - Barres : domaine `0...max(entries) + marge 10%`
  - Cumul : domaine `0...max(cumulative) + marge 10%`
  - Combiné : 2 axes indépendants normalisés
- ✅ Ajouter **tooltips interactifs** (tap sur chart) :
  - Afficher valeur + heure
  - Afficher delta vs heure précédente (si disponible)
  - Utiliser `RuleMark` + annotation pour position
- ✅ **Légendes explicites** :
  - Barres : "Entrées / heure (unité)"
  - Cumul : "Cumul journée (entrées)"
  - Couleurs cohérentes avec Nexus Design System
- ✅ Persister le mode sélectionné (UserDefaults ou @AppStorage)

## 4. Out-of-scope (bullets)
- ❌ Modification du chart "Taux de remplissage" (HistoryView) → ticket P0.3-B
- ❌ Modification des charts dans HistoryView (entries/cumul) → ticket P0.3-C
- ❌ Export/screenshot du chart → feature future
- ❌ Animations complexes → garder simple et performant
- ❌ Pinch to zoom → pas nécessaire pour v1
- ❌ Multi-touch gestures → tap simple suffit

## 5. Acceptance Criteria (bullets, objective)
1. **Toggle visible et fonctionnel** :
   - [ ] Un SegmentedControl avec 3 options : "Barres" | "Cumul" | "Combiné"
   - [ ] Placé juste au-dessus de la légende du chart
   - [ ] Changement de mode instantané (pas de reload)
   - [ ] Mode sélectionné persisté entre sessions

2. **Mode "Barres" seul** :
   - [ ] Affiche uniquement les barres d'entrées/heure
   - [ ] Axe Y gauche : domaine `0...max(entries) * 1.1`
   - [ ] Axe Y droit : caché
   - [ ] Légende : "Entrées / heure" uniquement

3. **Mode "Cumul" seul** :
   - [ ] Affiche uniquement la ligne de cumul
   - [ ] Axe Y gauche : domaine `0...max(cumulative) * 1.1`
   - [ ] Axe Y droit : caché
   - [ ] Légende : "Cumul journée" uniquement

4. **Mode "Combiné"** (défaut actuel) :
   - [ ] Affiche barres + ligne
   - [ ] Axe Y gauche (barres) : `0...max(entries) * 1.1`
   - [ ] Axe Y droit (cumul) : `0...max(cumulative) * 1.1`
   - [ ] Légende : "Entrées / heure" + "Cumul journée"

5. **Normalisation axes** :
   - [ ] Aucun axe ne démarre sous 0
   - [ ] Domaine Y stable (pas de saut visuel entre updates)
   - [ ] Marge 10% au-dessus du max pour respiration visuelle
   - [ ] Grid lines alignées sur valeurs entières

6. **Tooltips interactifs** :
   - [ ] Tap sur une barre ou point affiche un tooltip
   - [ ] Tooltip affiche : heure (ex: "14h"), valeur (ex: "12 entrées"), delta vs précédent (ex: "+3 vs 13h")
   - [ ] RuleMark vertical sur l'élément sélectionné
   - [ ] Annotation positionnée au-dessus sans overlap
   - [ ] Tap ailleurs ferme le tooltip

7. **Légendes claires** :
   - [ ] Unités explicites : "Entrées / heure", "Cumul (entrées)"
   - [ ] Couleurs cohérentes : accent pour barres, positive pour cumul
   - [ ] Symboles visuels : rectangle pour barres, ligne pour cumul

## 6. Edge Cases (bullets)
- **Données vides** :
  - Toggle visible mais chart affiche "Aucune donnée aujourd'hui"
  - Axes normalisés à `0...1` par défaut
  
- **1 seul point de données** :
  - Barres : affiche 1 barre, domaine `0...valeur * 1.1`
  - Cumul : affiche 1 point, domaine `0...valeur * 1.1`
  - Tooltip fonctionne, pas de delta (premier point)
  
- **Valeurs très grandes** :
  - Axes utilisent K/M notation (1000 → 1K, 1000000 → 1M)
  - Tooltip affiche valeurs complètes
  
- **Valeurs identiques** :
  - Si tous les points = même valeur, domaine `0...(valeur * 1.2)` pour éviter ligne plate
  
- **Changement de mode pendant tap** :
  - Tooltip fermé automatiquement
  - Sélection réinitialisée
  
- **Rotation device** :
  - Chart redimensionné correctement
  - Toggle reste visible
  
- **Dark mode** :
  - Couleurs s'adaptent (via Nexus.Colors)
  - Tooltip reste lisible

## 7. Suggested code areas/files (bullets, best guess)
1. **`ViewModels/DashboardViewModel.swift`**
   - Ajouter `enum ChartDisplayMode: String, CaseIterable { case bars, cumulative, combined }`
   - Ajouter `@AppStorage("chartDisplayMode") var chartDisplayMode: ChartDisplayMode = .combined`
   - Ajouter `var selectedHour: Date?` pour tooltip selection

2. **`Views/DashboardView.swift`**
   - Modifier `todayCombinedChartSection` pour ajouter le toggle
   - Refactoriser `combinedChart` en switch/case selon mode
   - Créer `barsOnlyChart`, `cumulativeOnlyChart`, `combinedChart`
   - Ajouter logique de tooltip avec `chartXSelection(value: $selectedHour)`
   - Créer `chartTooltip(for:)` view helper
   - Normaliser domaines Y avec `chartYScale(domain: ...)`

3. **`Models/` (nouveau)** :
   - Créer `ChartDisplayMode.swift` si besoin de logique complexe

4. **`DesignSystem/NexusDesignSystem.swift`** (optionnel) :
   - Ajouter `chartTooltipBackground`, `chartTooltipBorder` si couleurs custom nécessaires

## 8. Tests to add (bullets)
### Tests unitaires (in-app, style MetricsCalculatorSelfTests)
1. **Test domaine normalisé** :
   - Entrées : `[5, 10, 8, 12]` → domaine attendu `0...13.2` (max * 1.1)
   - Cumul : `[5, 15, 23, 35]` → domaine attendu `0...38.5`

2. **Test mode persistence** :
   - Changer mode → relancer app → mode restauré

3. **Test tooltip delta** :
   - Bucket(hour: 14, entries: 12), précédent = 9 → delta = "+3"
   - Premier bucket → delta = nil

### Tests manuels (UI)
1. **Toggle entre modes** :
   - Sélectionner "Barres" → seules barres visibles, axe droit caché
   - Sélectionner "Cumul" → seule ligne visible, axe gauche caché
   - Sélectionner "Combiné" → tout visible

2. **Normalisation axes** :
   - Vérifier que Y démarre toujours à 0
   - Ajouter 1 entrée → vérifier que domaine ne saute pas brutalement
   - Comparer visuellement "avant/après" normalisation

3. **Tooltips** :
   - Tap sur barre → tooltip apparaît
   - Tap ailleurs → tooltip disparaît
   - Vérifier valeurs affichées = valeurs réelles
   - Vérifier delta correct

4. **Edge cases** :
   - Tester avec 0 données
   - Tester avec 1 seul point
   - Tester avec 100+ entrées (grandes valeurs)

## 9. Risks/notes (bullets)
### Risks
- **Performance** : Re-render du chart à chaque tap peut être coûteux sur gros datasets
  - Mitigation : Utiliser `chartXSelection` natif (optimisé par Swift Charts)
  
- **UX confusion** : 3 modes peut être trop pour utilisateurs novices
  - Mitigation : Mode "Combiné" par défaut (état actuel), tooltip explicatif
  
- **Domaine Y instable** : Si données changent rapidement (live), axes peuvent "bouger"
  - Mitigation : Arrondir max à multiple de 5 ou 10 pour stabilité

### Notes
- **Swift Charts natif** : Utiliser `chartXSelection` pour tooltips (pas de custom gesture)
- **Accessibilité** : Ajouter `.accessibilityLabel()` sur toggle et chart
- **Haptic feedback** : Ajouter `.sensoryFeedback()` lors du tap sur chart (iOS 17+)
- **Cohérence** : Appliquer même pattern pour charts HistoryView (tickets B/C)

---

## 10. Proposition de découpage tickets suivants (P0.3-B/C/D)

### P0.3-B — Chart "Taux de remplissage" (HistoryView) : Toggle + Normalisation
- Ajouter toggle Barres/Ligne pour chart "Taux de remplissage" (%)
- Normaliser axe Y : `0...100%` fixe (pas de variation)
- Tooltips : valeur % + jour + delta vs jour précédent

### P0.3-C — Chart "Entrées" (HistoryView) : Toggle + Normalisation + Tooltips
- Appliquer même logique que P0.3-A mais pour chart historique (7j/30j/Année)
- Toggle : Barres seules / Cumul seul / Combiné (dual Y-axis)
- Tooltips : valeur + date + delta vs période équivalente précédente
- Normalisation : domaines stables + marge 10%

### P0.3-D — Unités explicites + accessibilité (tous charts)
- Ajouter labels d'unités sur tous les axes Y ("Entrées", "%", "Cumul")
- Ajouter `.accessibilityLabel()` descriptif sur tous les charts
- Ajouter haptic feedback sur interactions
- Vérifier lisibilité en dark mode + contraste WCAG AA

---

## ✅ Résumé : Ticket P0.3-A est atomique et vérifiable

**Outcome unique** : Chart "Flux d'entrées" (DashboardView) a un toggle fonctionnel, axes normalisés, et tooltips interactifs.

**Vérification** : 
1. Toggle visible avec 3 options
2. Chaque mode affiche correctement (visuellement distinct)
3. Axes Y démarrent à 0 avec marge 10%
4. Tap sur chart affiche tooltip avec valeur + delta
