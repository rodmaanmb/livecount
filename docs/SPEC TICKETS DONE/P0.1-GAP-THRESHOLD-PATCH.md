# üîß Patch P0.1: Red√©finition des Seuils de D√©tection de Gaps

**Date:** 27 janvier 2026  
**Ticket:** P0.1 Data Integrity ‚Äî Gap Detection Thresholds  
**Status:** ‚úÖ Impl√©ment√©

---

## üìä Probl√®me Initial

### Comportement Observ√©
- **Gap 13:01‚Äì13:17 (16 min)** : flagg√© comme "warning" alors que c'est une variation normale
- **Gap 22:59‚Äì10:03 (~11h)** : trait√© comme un probl√®me alors que c'est probablement une fermeture (inactivit√© attendue)

### Cause Racine
- **Seuil unique arbitraire:** 15 minutes
- **Aucune distinction** entre :
  - Inactivit√© normale (fermeture, nuit, ralentissement)
  - Probl√®me r√©el (device offline, perte de donn√©es)

---

## ‚úÖ Solution Impl√©ment√©e

### 1. **Deux Seuils + Classification**

```swift
struct DataGapConfiguration {
    let displayThreshold: TimeInterval      // 20 min ‚Äî seuil minimal d'affichage
    let issueThreshold: TimeInterval        // 60 min ‚Äî seuil de probl√®me d√©tectable
    let inactivityThreshold: TimeInterval   // 6h ‚Äî inactivit√© attendue (fermeture)
    
    static let `default` = DataGapConfiguration(
        displayThreshold: 20 * 60,
        issueThreshold: 60 * 60,
        inactivityThreshold: 6 * 60 * 60
    )
}
```

### 2. **S√©v√©rit√© des Gaps**

```swift
enum GapSeverity {
    case info          // 20‚Äì59 min: ralentissement normal (non flagg√©)
    case warning       // 1‚Äì3h: gap significatif (issue)
    case critical      // 3‚Äì6h: probl√®me majeur (issue)
    case inactivity    // > 6h: probablement fermeture (non flagg√©)
}
```

### 3. **Nouvelle Logique**

| Dur√©e du Gap | Classification | Action |
|--------------|----------------|--------|
| **< 20 min** | *(ignor√©)* | Pas d'affichage |
| **20‚Äì59 min** | `.info` | D√©tect√© mais pas flagg√© comme issue |
| **1‚Äì3h** | `.warning` | Flagg√© comme issue (warning) |
| **3‚Äì6h** | `.critical` | Flagg√© comme issue (critical) |
| **> 6h** | `.inactivity` | Inactivit√© attendue (non flagg√©) |

---

## üìÅ Fichiers Modifi√©s

### 1. `DataIntegrityValidator.swift`
**Ajouts:**
- `DataGapConfiguration` struct (config des seuils)
- `GapSeverity` enum (classification)
- `ClassifiedGap` struct (gap avec s√©v√©rit√©)
- `detectGapsWithClassification()` ‚Äî nouvelle m√©thode principale
- Garde `detectGaps()` pour backward compatibility

**Modifications:**
- `validate()` : utilise `config: DataGapConfiguration` au lieu de `maxGapThreshold`
- `computeCoverageWindow()` : utilise `config` et ne retourne que les gaps significatifs (warning/critical)

### 2. `MetricsCalculator.swift`
**Ligne 53-63:**
```swift
let config = DataGapConfiguration.default
let issues = DataIntegrityValidator.validate(
    entries: entries,
    timeRange: timeRange.interval,
    config: config
)

let coverage = DataIntegrityValidator.computeCoverageWindow(
    entries: entries,
    config: config
)
```

### 3. `LiveAggregator.swift`
**Ligne 115-129:**
```swift
// Use longer threshold for live window (dynamic context)
let config = DataGapConfiguration(
    displayThreshold: 20 * 60,
    issueThreshold: TimeInterval(windowDurationMinutes * 60),
    inactivityThreshold: 6 * 60 * 60
)

let issues = DataIntegrityValidator.validate(...)
let coverage = DataIntegrityValidator.computeCoverageWindow(...)
```

### 4. `DataIntegrityValidatorTests.swift`
**5 nouveaux tests ajout√©s:**
1. `testGapsBelowDisplayThresholdAreIgnored()` ‚Äî < 20 min ignor√©s
2. `testGaps20to59MinutesDisplayedButNotFlagged()` ‚Äî 20-59 min d√©tect√©s mais pas flagg√©s
3. `testGaps60to180MinutesFlaggedAsWarning()` ‚Äî 1-3h = warning
4. `testGapsOver3HoursFlaggedAsCritical()` ‚Äî 3-6h = critical
5. `testGapsOver6HoursClassifiedAsInactivity()` ‚Äî > 6h = inactivit√© attendue

---

## üß™ Tests Ajout√©s

### Test 6: Gaps < 20 min ignor√©s
```swift
// Gap de 15 min ‚Üí aucune issue d√©tect√©e ‚úì
```

### Test 7: Gap 20-59 min (info, non flagg√©)
```swift
// Gap de 45 min ‚Üí classifi√© .info, mais PAS dans les issues ‚úì
```

### Test 8: Gap 60-180 min (warning)
```swift
// Gap de 2h ‚Üí flagg√© comme warning ‚úì
```

### Test 9: Gap > 3h (critical)
```swift
// Gap de 4.5h ‚Üí flagg√© comme critical ‚úì
```

### Test 10: Gap > 6h (inactivit√©)
```swift
// Gap de 12h (22h ‚Üí 10h) ‚Üí classifi√© inactivity, PAS flagg√© ‚úì
```

**Comment ex√©cuter:**
```swift
// Dans l'app (DEBUG build)
DataIntegrityValidatorTests.runAllTests()
```

---

## üéØ Edge Cases G√©r√©s

### ‚úÖ Cross-Midnight
- **Exemple:** Gap 22:59 ‚Üí 10:03 (11h)
- **Solution:** `DateInterval` g√®re nativement les transitions de jour
- **Test:** `testGapsOver6HoursClassifiedAsInactivity()` avec `dateNextDay()`

### ‚úÖ Merge/D√©dup
- Un seul gap par p√©riode d√©tect√© entre deux events cons√©cutifs
- Pas de chevauchement possible

### ‚úÖ Empty Entries
- `guard !entries.isEmpty` ‚Üí retour vide propre

### ‚úÖ Single Entry
- `guard entries.count > 1` ‚Üí pas de gaps possibles

---

## üìä Impact Attendu

### Avant le Patch
```
Issues d√©tect√©es:
- 13:01‚Äì13:17 (16 min) ‚ùå faux positif
- 22:59‚Äì10:03 (11h) ‚ùå faux positif (inactivit√© normale)
```

### Apr√®s le Patch
```
Issues d√©tect√©es:
- (aucune si tout est normal)

Gaps d√©tect√©s mais non flagg√©s:
- 13:01‚Äì13:17 (16 min) ‚Üí ‚ùå ignor√© (< 20 min)
- 22:59‚Äì10:03 (11h) ‚Üí ‚ÑπÔ∏è classifi√© "inactivit√©" (non probl√©matique)
```

---

## üîÑ Backward Compatibility

### Legacy Support
```swift
// Ancienne signature (encore fonctionnelle)
DataIntegrityValidator.validate(
    entries: entries,
    timeRange: timeRange,
    maxGapThreshold: 15 * 60  // ‚ùå deprecated mais fonctionne
)

// Nouvelle signature recommand√©e
DataIntegrityValidator.validate(
    entries: entries,
    timeRange: timeRange,
    config: .default  // ‚úÖ nouveau param√®tre avec valeur par d√©faut
)
```

La m√©thode `detectGaps(threshold:)` existe toujours et appelle en interne `detectGapsWithClassification()`.

---

## ‚ö†Ô∏è Risques & Suivi

### Risques Identifi√©s
1. **Breaking change mineur:** signature de `validate()` change  
   ‚Üí ‚úÖ Mitig√© avec param√®tre `config` optionnel (valeur par d√©faut)

2. **Moins de gaps affich√©s dans l'UI**  
   ‚Üí ‚úÖ C'est le comportement souhait√© (moins de faux positifs)

3. **Seuils arbitraires (20 min, 60 min, 6h)**  
   ‚Üí üîÑ √Ä valider avec les donn√©es r√©elles de production

### Suivi Recommand√©
- [ ] Tester avec donn√©es r√©elles sur 7 jours
- [ ] Affiner `inactivityThreshold` si n√©cessaire (ex: heures d'ouverture connues)
- [ ] Monitorer les issues flagg√©es pendant 1 semaine
- [ ] Ajuster `displayThreshold` si besoin (15 min vs 20 min)

---

## üìù Notes de D√©ploiement

### Pas d'Action Requise
- Pas de migration de donn√©es
- Pas de modification de sch√©ma
- Backward compatible

### Validation Recommand√©e
1. Lancer `DataIntegrityValidatorTests.runAllTests()` en DEBUG
2. V√©rifier que tous les tests passent (11 tests au total)
3. Observer l'UI History avec les nouvelles r√®gles

---

## ‚úÖ Checklist d'Impl√©mentation

- [x] Ajouter `DataGapConfiguration` + `GapSeverity` + `ClassifiedGap`
- [x] Remplacer `detectGaps()` par `detectGapsWithClassification()`
- [x] Mettre √† jour `validate()` avec nouvelle logique
- [x] Mettre √† jour `computeCoverageWindow()` avec config
- [x] Adapter `MetricsCalculator.swift` call sites
- [x] Adapter `LiveAggregator.swift` call sites
- [x] Ajouter 5 tests pour nouveaux seuils
- [x] V√©rifier linting (0 erreurs)
- [x] Documenter le patch

---

**Impl√©ment√© par:** AI Assistant  
**Valid√© par:** Roman M'BARALI (en attente)  
**Version:** P0.1.1
