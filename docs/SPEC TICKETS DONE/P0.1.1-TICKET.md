# ✅ P0.1.1 — Redéfinition Hard Issues vs Soft Signals

**Status:** COMPLETED  
**Date:** 27 janvier 2026

---

## Summary

Redéfini les niveaux de sévérité d'intégrité pour distinguer clairement :
- **Hard Issues (critical)** : Incohérences prouvées (people_present < 0) → bandeau rouge
- **Soft Signals (info)** : Comportements normaux (drain négatif, inactivité) → section info neutre

---

## Approach

1. **Créer `DataFlowSignal` model** : Nouveau type pour signaux contextuels (distinct de `DataIntegrityIssue`)
2. **Modifier `DataIntegrityValidator`** :
   - `validate()` ne retourne QUE les hard issues (people_present < 0)
  - Nouvelle méthode `analyzeFlowSignals()` pour soft signals
3. **Mettre à jour models** :
   - `CounterState` + `MetricsSnapshot` : ajouter `dataFlowSignals: [DataFlowSignal]`
   - Computed properties : `hasHardIntegrityIssues`, `hasSoftSignals`
4. **Adapter UI** :
   - `hardIntegrityBanner` : rouge critique, bordure épaisse
   - `softSignalsSection` : neutre, icône info
5. **Tests unitaires** : 6 scénarios couvrant hard vs soft

---

## Files Changed

### Models
1. `Models/DataIntegrityIssue.swift`
   - Ajout `DataFlowSignal` struct avec `SignalType` enum
   - Mise à jour commentaires `DataIntegrityIssue` (P0.1.1)
   - Dépréciation `.warning` severity

2. `Models/CounterState.swift`
   - Ajout `dataFlowSignals: [DataFlowSignal]`
   - Ajout `hasHardIntegrityIssues`, `hasSoftSignals` computed properties

3. `Models/MetricsSnapshot.swift`
   - Ajout `dataFlowSignals: [DataFlowSignal]`
   - Ajout `hasHardIntegrityIssues`, `hasSoftSignals` computed properties

### Services
4. `Services/DataIntegrityValidator.swift`
   - Modifier `validate()` : HARD issues uniquement (signature simplifiée, config retiré)
   - Ajout `analyzeFlowSignals()` : détection negative drain + inactivity

5. `Services/LiveAggregator.swift`
   - Appeler `validate()` + `analyzeFlowSignals()` séparément
   - Passer `hardIssues` et `softSignals` dans `CounterState`

6. `Services/MetricsCalculator.swift`
   - Appeler `validate()` + `analyzeFlowSignals()` séparément
   - Passer `hardIssues` et `softSignals` dans `MetricsSnapshot`

### ViewModels
7. `ViewModels/DashboardViewModel.swift`
   - Ajout `dataFlowSignals: [DataFlowSignal]`
   - Ajout `hasHardIntegrityIssues`, `hasSoftSignals` computed properties
   - Mise à jour dans `startLiveMode()` : assigner `state.dataFlowSignals`

### Views
8. `Views/DashboardView.swift`
   - Remplacer `dataIntegrityBanner` par `hardIntegrityBanner` (rouge critique)
   - Ajout `softSignalsSection` (neutre, info)
   - Conditions : `hasHardIntegrityIssues` vs `hasSoftSignals`

### Tests
9. `Services/DataIntegrityP011Tests.swift` (NEW)
   - 6 tests unitaires couvrant tous les scénarios du ticket

---

## Tests Added

### Tests unitaires (in-app, DataIntegrityP011Tests)

1. **testHardIssue_NegativeCount**
   - Entrées : +5, -3, -4 → count = -2
   - Résultat : 1 hard issue, severity = .critical

2. **testSoftSignal_NegativeDrain**
   - Entrées : +100, -60, -30 → count = 10 (ok), net flow = +10
   - Résultat : NO hard issue, soft signals analysés

3. **testNoHardIssue_MassiveDrainButCountStaysPositive**
   - Entrées : +100, -90, -10 → count = 0 (ok)
   - Résultat : NO hard issue, soft signal negative drain détecté

4. **testSoftSignal_InactivityPeriod**
   - Gap de 8h entre deux events
   - Résultat : soft signal inactivity détecté

5. **testNoIssues_NormalActivity**
   - Activité normale (+10, +5, -3)
   - Résultat : NO hard issues, 0-N soft signals selon thresholds

6. **testMultipleHardIssues**
   - Count passe négatif 2 fois dans la période
   - Résultat : 2 hard issues détectés

**Comment lancer :**
```swift
#if DEBUG
DataIntegrityP011Tests.runAllTests()
#endif
```

---

## Edge Cases Handled

### ✅ AC1 : Hard Issues (bandeau d'alerte)
- people_present < 0 → `DataIntegrityIssue(type: .negativeCount, severity: .critical)`
- Bandeau rouge visible dans Dashboard (selectedPeriod == .today)
- Message : "Incohérence : compteur négatif (-X) à HH:mm"
- **Testé** : testHardIssue_NegativeCount, testMultipleHardIssues

### ✅ AC2 : Soft Signals (negative drain)
- Net flow < -10 → `DataFlowSignal.negativeDrain`
- Section info neutre, icône ℹ️
- Message : "Drain net: -X entrées (sorties > entrées, normal en fin de période)"
- **Testé** : testNoHardIssue_MassiveDrainButCountStaysPositive

### ✅ AC3 : Soft Signals (inactivity)
- Gap > 6h → `DataFlowSignal.inactivityPeriod`
- Section info neutre
- Message : "Inactivité: HH:mm–HH:mm (Xh, club fermé ou matériel inactif)"
- **Testé** : testSoftSignal_InactivityPeriod

### ✅ AC4 : Séparation UI
- `hardIntegrityBanner` : rouge, bordure 2px, .negative colors
- `softSignalsSection` : neutre, .surface background, .textSecondary colors
- Conditions distinctes : `hasHardIntegrityIssues` vs `hasSoftSignals`

### ✅ AC5 : Backward compatibility
- `hasDataIssues` deprecated mais conservé (return `hasHardIntegrityIssues`)
- Migration douce : anciennes données fonctionnent sans crash

### ✅ AC6 : Edge cases
- **Fin de soirée** : drain -90, count >= 0 → soft signal, PAS d'alerte
- **Bug matériel** : count < 0 → hard issue (bandeau rouge)
- **Club fermé** : 8h sans events → soft signal inactivity

---

## Risks / Follow-ups

### Risks

1. **Faux négatifs**
   - Si seuil drain trop permissif (-10), peut manquer anomalie réelle
   - Mitigation : Seuils ajustables via `DataGapConfiguration`

2. **Performance (double validation)**
   - Appeler `validate()` + `analyzeFlowSignals()` = 2 passes
   - Mitigation : Acceptable pour v1, optimisable en un pass si nécessaire

3. **Confusion utilisateur**
   - Changement de comportement (moins de bandeaux)
   - Mitigation : Release notes, section "Activité" pour info

### Follow-ups

1. **ML/Pattern Recognition (v2)**
   - Détecter anomalies subtiles (ex: pic inhabituel, pattern anormal)
   - `DataFlowSignal.highActivity` déjà prévu pour cela

2. **Alertes push (v2)**
   - Notifier admin en cas de hard issue critical
   - Ne pas spammer pour soft signals

3. **Dashboard admin (v2)**
   - Historique des hard issues sur plusieurs jours
   - Graphes de drainage/inactivité

---

## Verification

### Vérification manuelle (Simulator)

1. **Scénario "people_present < 0"**
   - [ ] Créer entrées : +5, -3, -8 dans DemoDataSeeder
   - [ ] Vérifier bandeau rouge visible avec "Incohérence détectée"
   - [ ] Vérifier message : "compteur négatif (-6) à HH:mm"

2. **Scénario "drain négatif"**
   - [ ] Créer entrées : +100, -50, -40 (count = 10, ok)
   - [ ] Vérifier AUCUN bandeau rouge
   - [ ] Vérifier section "Activité" visible avec message drain

3. **Scénario "inactivité"**
   - [ ] Créer gap de 8h entre deux events
   - [ ] Vérifier section "Activité" avec message inactivité
   - [ ] Vérifier icône ℹ️ (pas ⚠️)

4. **Scénario "normal"**
   - [ ] Créer activité normale (+10, +5, -3)
   - [ ] Vérifier AUCUN bandeau rouge
   - [ ] Vérifier section "Activité" vide ou avec signaux neutres

### Tests automatiques

```bash
# Dans Xcode Console
DataIntegrityP011Tests.runAllTests()
# Expected: "✅ [P0.1.1 Tests] All tests passed!"
```

---

## Notes Produit

**Philosophie "Cry Wolf"**
- Trop d'alertes = utilisateur ignore tout
- **Hard issues** : Rares, critiques, action immédiate requise
- **Soft signals** : Fréquents, normaux, info contextuelle

**Distinction claire**
- Bandeau rouge = **problème prouvé** (people_present impossible)
- Section info = **comportement observé** (peut être normal)

**UX Future**
- Section "Activité" collapsible par défaut (moins intrusive)
- Onboarding : expliquer différence hard/soft
- Lien "En savoir plus" vers docs

---

## ✅ Ticket P0.1.1 COMPLETED

**Outcome** : Redéfinition claire hard vs soft, UI cohérente, tests passent.

**Impact** :
- ✅ Moins de faux positifs (bandeaux pour vrais problèmes uniquement)
- ✅ Meilleure UX (info contextuelle sans alarmer)
- ✅ Base pour ML/anomaly detection (v2)
